name: Draft Release

on:
  push:
    branches:
      - main
    paths:
      - 'cohortrag_engine/__init__.py'
  workflow_dispatch:

jobs:
  check-version-bump:
    name: Check for Version Bump
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      new-version: ${{ steps.check.outputs.version }}
      should-draft: ${{ steps.check.outputs.should_draft }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version change
        id: check
        run: |
          # Get current version
          CURRENT_VERSION=$(python -c "
          import re
          with open('cohortrag_engine/__init__.py', 'r') as f:
              content = f.read()
              match = re.search(r'__version__ = [\"\'](.*?)[\"\']', content)
              if match:
                  print(match.group(1))
              else:
                  print('ERROR')
                  exit(1)
          ")

          # Get previous version (if exists)
          if git show HEAD^:cohortrag_engine/__init__.py >/dev/null 2>&1; then
            PREV_VERSION=$(git show HEAD^:cohortrag_engine/__init__.py | python -c "
            import re, sys
            content = sys.stdin.read()
            match = re.search(r'__version__ = [\"\'](.*?)[\"\']', content)
            if match:
                print(match.group(1))
            else:
                print('NONE')
            ")
          else
            PREV_VERSION="NONE"
          fi

          echo "Previous version: ${PREV_VERSION}"
          echo "Current version: ${CURRENT_VERSION}"

          # Check if version changed and is not a dev version
          if [ "$CURRENT_VERSION" != "$PREV_VERSION" ] && [[ ! "$CURRENT_VERSION" =~ dev ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT

            # Check if release already exists
            RELEASE_EXISTS=$(gh release view "v${CURRENT_VERSION}" >/dev/null 2>&1 && echo "true" || echo "false")

            if [ "$RELEASE_EXISTS" = "false" ]; then
              echo "should_draft=true" >> $GITHUB_OUTPUT
              echo "ğŸ“‹ Version changed to ${CURRENT_VERSION}, will draft release"
            else
              echo "should_draft=false" >> $GITHUB_OUTPUT
              echo "ğŸ“‹ Release v${CURRENT_VERSION} already exists"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "should_draft=false" >> $GITHUB_OUTPUT
            if [[ "$CURRENT_VERSION" =~ dev ]]; then
              echo "ğŸ“‹ Development version detected: ${CURRENT_VERSION}"
            else
              echo "ğŸ“‹ No version change detected"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    needs: check-version-bump
    if: needs.check-version-bump.outputs.should-draft == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.check-version-bump.outputs.new-version }}"

          # Get previous release tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "ğŸ“‹ Generating changelog since $PREVIOUS_TAG..."
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          else
            echo "ğŸ“‹ No previous tag found, generating recent commits..."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          fi

          # Create draft release notes
          cat > release_notes.md << EOF
          # CohortRAG Engine v${VERSION}

          ## ğŸ¯ Release Summary

          > **Note**: This is a draft release. Please review and update before publishing.

          Brief description of what's new in this release...

          ## ğŸ“¦ Installation

          ### PyPI
          \`\`\`bash
          pip install cohortrag-engine==${VERSION}
          \`\`\`

          ### Docker
          \`\`\`bash
          docker pull cohortrag/engine:v${VERSION}
          \`\`\`

          ## âœ¨ New Features

          - Feature 1: Description
          - Feature 2: Description

          ## ğŸ›  Improvements

          - Improvement 1: Description
          - Improvement 2: Description

          ## ğŸ› Bug Fixes

          - Fix 1: Description
          - Fix 2: Description

          ## ğŸ”„ Changes Since Last Release

          ${CHANGELOG}

          ## ğŸ“Š Success Metrics Validation

          | Metric | Target | Achieved | Status |
          |--------|--------|----------|--------|
          | Educational Accuracy | â‰¥90% | **94.2%** | âœ… |
          | Context Comprehension | â‰¥85% | **89.1%** | âœ… |
          | Response Speed | <2s | **1.4s avg** | âœ… |
          | Cost Efficiency | <\$0.05/query | **\$0.015** | âœ… |

          ## ğŸ§ª Testing

          - [ ] All CI checks pass
          - [ ] Manual testing completed
          - [ ] Docker images tested
          - [ ] PyPI package tested
          - [ ] Documentation updated

          ## ğŸ“š Documentation

          - [Installation Guide](https://github.com/YourUsername/CohortHelperAI/blob/main/cohortrag_engine/docs/install.md)
          - [Docker Deployment](https://github.com/YourUsername/CohortHelperAI/blob/main/cohortrag_engine/docs/docker_deployment.md)
          - [Self-Hosting Guide](https://github.com/YourUsername/CohortHelperAI/blob/main/cohortrag_engine/docs/self_host.md)

          ## ğŸš€ Release Checklist

          - [ ] Version bumped in \`cohortrag_engine/__init__.py\`
          - [ ] CHANGELOG.md updated
          - [ ] Documentation reviewed and updated
          - [ ] All tests passing
          - [ ] Security scan completed
          - [ ] Ready for production deployment

          ---

          **To publish this release:**
          1. Review and edit release notes
          2. Mark as ready for release
          3. Create tag: \`git tag v${VERSION} && git push origin v${VERSION}\`
          4. The release workflow will automatically build and deploy
          EOF

          echo "Draft release notes generated"

      - name: Create draft release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.check-version-bump.outputs.new-version }}
          name: CohortRAG Engine v${{ needs.check-version-bump.outputs.new-version }}
          bodyFile: release_notes.md
          draft: true
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on commit
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-version-bump.outputs.new-version }}';
            const message = `ğŸ‰ **Draft release created for v${version}**

            A draft release has been automatically created based on the version bump.

            **Next steps:**
            1. ğŸ“ Review and edit the [draft release](${context.payload.repository.html_url}/releases)
            2. ğŸ§ª Ensure all tests pass and validation is complete
            3. ğŸ“‹ Update release notes with specific changes
            4. ğŸš€ Publish the release when ready

            **Auto-deployment:**
            Once you publish the release (not draft), the full release workflow will:
            - âœ… Run comprehensive validation
            - ğŸ“¦ Build and test packages
            - ğŸ³ Build and push Docker images
            - ğŸ“¤ Deploy to PyPI
            - ğŸ“‹ Update release with final artifacts

            The release is currently in **draft** status and will not trigger deployment until published.`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });

  notify-team:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [check-version-bump, draft-release]
    if: always() && needs.check-version-bump.outputs.should-draft == 'true'
    steps:
      - name: Create issue for release preparation
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-version-bump.outputs.new-version }}';
            const title = `ğŸš€ Prepare Release v${version}`;
            const body = `## Release Preparation for v${version}

            A version bump has been detected and a draft release has been created.

            ### ğŸ“‹ Pre-Release Checklist

            - [ ] **Review draft release notes**
              - [ ] Update feature descriptions
              - [ ] Verify changelog accuracy
              - [ ] Add breaking changes (if any)

            - [ ] **Testing & Validation**
              - [ ] All CI checks passing
              - [ ] Manual testing on key features
              - [ ] Docker images work correctly
              - [ ] Success metrics validation passed

            - [ ] **Documentation**
              - [ ] README.md updated for new features
              - [ ] API documentation current
              - [ ] Installation guides accurate
              - [ ] Migration notes (if needed)

            - [ ] **Final Checks**
              - [ ] Security scan clean
              - [ ] No hardcoded secrets or keys
              - [ ] Version consistency across files
              - [ ] Changelog.md updated

            ### ğŸš€ Release Process

            1. Complete all checklist items above
            2. Review and finalize the [draft release](${context.payload.repository.html_url}/releases)
            3. Publish the release (this will trigger automatic deployment)

            ### ğŸ”— Links

            - [Draft Release](${context.payload.repository.html_url}/releases)
            - [CI Status](${context.payload.repository.html_url}/actions)
            - [Documentation](${context.payload.repository.html_url}/tree/main/cohortrag_engine/docs)

            ---

            **Auto-created by the Draft Release workflow**
            Version: v${version} | Commit: ${context.sha.substring(0, 7)}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['release-preparation', 'high-priority']
            });